# 话剧视频三阶段增强策略

## 总体架构

```
原始视频 (1920x1080)
    ↓
[Stage 1] Real-ESRGAN x2 全片处理
    ↓
中间结果 (3840x2160)
    ↓
[Stage 2] Video SR 关键片段增强 (可选)
    ↓
增强结果 (3840x2160)
    ↓
[Stage 3] Lanczos 最终统一
    ↓
最终输出 (3840x2160 标准4K)
```

---

## Stage 1: Real-ESRGAN x2 (全片主流程) ✅

### 为什么必须是它？
1. **6GB 显存唯一稳定方案**: RTX 2060 能跑完整视频
2. **单帧 GAN 对静态画面效果好**: 话剧舞台场景适合
3. **成本可控**: 40 小时处理时间可接受
4. **成熟稳定**: 经过大量验证

### 固定参数（不要再改）
```python
model_name = "RealESRGAN_x2plus"
tile_size = 384  # ⚠️ 不是 512！384 在 6GB 更稳定
half = True      # FP16 开启
face_enhance = False  # 关闭（话剧不需要）
batch_size = 1   # 单帧处理
```

### 为什么 tile=384？
- **512**: 理论更快，但在 6GB 显存容易 OOM
- **384**: 更稳定，实际吞吐更高（不会因 OOM 重试）
- **话剧场景**: 大量群舞、全景，384 更安全

### 当前状态
- ✅ 已实现
- ✅ 正在测试 30 秒片段
- ⏳ 待验证完整视频稳定性

---

## Stage 2: Video SR (关键片段增强) ⚠️

### 为什么需要这一层？
Real-ESRGAN 的**致命短板**：
1. **人物走动**: 皮肤纹理闪烁
2. **细节"呼吸感"**: 帧间不一致
3. **群舞/转身**: 细节跳变

这些问题**只有时序模型能解决**。

### 为什么是 EDVR/RealBasicVSR？

| 模型 | 6GB 显存 | 话剧适配 | 风险 | 结论 |
|------|---------|---------|------|------|
| SeedVR2 | ❌ 炸 | 很好 | 高 | 不可行 |
| FlashVSR | ⚠️ 勉强 | 中等 | 中 | 不成熟 |
| **EDVR/RBVSR** | ✅ 可控 | 非常适合 | 低 | **推荐** |

### EDVR 在话剧场景的优势
1. **多帧融合** → 消除闪烁
2. **不生成夸张伪细节** → 保持真实感
3. **舞台灯光/服装纹理稳定** → 适合话剧
4. **老模型** → 刚好适配 6GB 显存

### 使用策略
- **不是全片**: 只处理 5-15% 关键片段
- **识别关键片段**:
  - 人物特写
  - 快速走动
  - 群舞场景
  - 转身/旋转
- **其他部分**: 保持 Stage 1 结果

### 实施计划
1. **Phase 1**: 先完成 Stage 1 测试
2. **Phase 2**: 评估是否有明显闪烁
3. **Phase 3**: 如果需要，再实施 EDVR
   - 安装 BasicSR/MMEditing
   - 下载 EDVR 模型
   - 实现时序处理
   - 测试显存占用

### 当前状态
- ⏸️ 暂不实施
- 📋 等待 Stage 1 测试结果
- 🎯 如果有闪烁问题再启动

---

## Stage 3: Lanczos 最终统一 ✅

### 为什么必须有这一步？
1. **保证整体一致性**: 统一所有片段的风格
2. **防止 AI 过拟合**: 消除 AI 生成的不自然细节
3. **标准化输出**: 确保符合播放标准

### 实施方式
```bash
ffmpeg -i stage1_or_stage2_output.mp4 \
  -vf "scale=3840:2160:flags=lanczos" \
  -c:v libx264 -crf 16 -preset slow \
  -c:a copy \
  final_4k.mp4
```

### 参数说明
- **lanczos**: 高质量传统算法
- **crf 16**: 高质量编码（16-18 推荐）
- **preset slow**: 慢速但高质量
- **音频**: 直接复制，不重新编码

### 处理时间
- 约 5-10 分钟（38 分钟视频）
- 相比 Stage 1 的 40 小时，可忽略

### 当前状态
- ✅ 方案确定
- ⏳ 等待 Stage 1/2 完成后执行

---

## 完整工作流

### 测试阶段（当前）
```bash
# 1. 测试 30 秒片段
python process_test_2min.py

# 2. 检查效果
# - 画质提升
# - 是否有闪烁
# - 显存占用

# 3. 决定是否需要 Stage 2
```

### 生产阶段（完整视频）
```bash
# Stage 1: Real-ESRGAN x2 全片
python process_target_gpu_final.py
# 选择模式 2 (快速模式 x2)
# 输出: target_gpu_2k_enhanced.mp4

# Stage 2: Video SR 关键片段（如果需要）
# 手动识别关键片段
# 使用 EDVR 处理
# 合并回主视频

# Stage 3: Lanczos 最终统一
ffmpeg -i target_gpu_2k_enhanced.mp4 \
  -vf "scale=3840:2160:flags=lanczos" \
  -c:v libx264 -crf 16 -preset slow \
  -c:a copy \
  target_final_4k.mp4
```

---

## 预期效果

### Stage 1 单独效果
- ✅ 分辨率: 1920x1080 → 3840x2160
- ✅ 细节增强: AI 修复纹理
- ⚠️ 可能问题: 人物走动时轻微闪烁

### Stage 1 + Stage 2 效果
- ✅ 分辨率: 同上
- ✅ 细节增强: 同上
- ✅ 时序稳定: 消除闪烁
- ✅ 人物走动: 流畅自然

### Stage 1/2 + Stage 3 效果
- ✅ 所有上述优点
- ✅ 整体一致: 风格统一
- ✅ 自然真实: 消除 AI 过拟合

---

## 时间成本

| 阶段 | 处理时间 | 必须性 |
|------|---------|--------|
| Stage 1 | 40 小时 | ✅ 必须 |
| Stage 2 | 2-6 小时 | ⚠️ 可选 |
| Stage 3 | 10 分钟 | ✅ 必须 |
| **总计** | **40-46 小时** | - |

---

## 决策树

```
开始
  ↓
Stage 1 测试 (30秒)
  ↓
效果满意？
  ├─ 是 → 直接处理完整视频 → Stage 3 → 完成
  └─ 否 → 有闪烁问题？
           ├─ 是 → 实施 Stage 2 → Stage 3 → 完成
           └─ 否 → 调整参数 → 重新测试
```

---

## 当前行动计划

### 立即执行 ✅
1. ✅ 修正 tile_size = 384
2. ✅ 运行 30 秒测试
3. ⏳ 评估效果

### 短期计划 📋
1. 如果测试满意 → 处理完整视频
2. 如果有闪烁 → 研究 EDVR 实施

### 长期计划 🎯
1. 完成 Stage 1 全片处理
2. 根据需要实施 Stage 2
3. Stage 3 最终统一
4. 交付最终 4K 视频

---

**最后更新**: 2026-01-15  
**当前状态**: Stage 1 测试中  
**下一步**: 运行 `python process_test_2min.py`
