# Huaju4K 话剧母版级4K增强系统 - 需求规格书

## 项目概述

### 目标
将现有Huaju4K视频增强系统从「通用视频超分」升级为「话剧母版级4K增强系统」，实现A路线画质天花板方案。

### 核心原则
- **不破坏现有架构**：在现有7阶段流程基础上扩展能力
- **不引入主观判断**：只允许数值统计、阈值判断、状态机
- **硬件约束遵循**：严格控制6GB显存限制
- **工程级交付**：可长时间离线处理，适合Kiro IDE执行

## 功能需求

### FR-001: 舞台结构分析能力
**描述**: Stage 1升级为舞台结构分析器
**输入**: 视频文件
**输出**: 结构特征JSON
**关键指标**:
- 固定机位检测（frame_diff_mean < 0.02）
- 舞台灯光分析（highlight_ratio, dark_ratio）
- 边缘密度统计（edge_density）
- 噪声评估（noise_score）

### FR-002: 分层增强策略生成
**描述**: Stage 2升级为策略翻译器
**输入**: Stage 1结构特征JSON
**输出**: 机器可执行策略JSON
**策略维度**:
- 分辨率路径规划
- GAN允许度控制
- 分层处理开关
- 时序锁定策略

### FR-003: 策略驱动模型调度
**描述**: Stage 3升级为策略执行器
**约束**: 任意时刻最多1个模型驻留显存
**行为**: 即用即载，用完即卸，失败回退

### FR-004: 三阶段视频增强
**描述**: Stage 4拆分为3个子阶段
- **Stage 4.1**: 结构重建（Structure SR, x2）
- **Stage 4.2**: 受控GAN增强（仅安全区域）
- **Stage 4.3**: 时序锁定与稳定

### FR-005: 母版级音频增强
**描述**: Stage 5升级为主叙事通道
**处理流程**:
- 音轨分离（对白/音乐/环境）
- 对白清晰度增强
- 音乐频段回退
- 环境空间感保留
- 母版级重混

### FR-006: 质量验证升级
**描述**: Stage 7新增母版级验证维度
**验证项目**:
- 帧间亮度波动
- 边缘稳定性
- 高光溢出检测
- 音频对白清晰度
- 音量一致性

## 非功能需求

### NFR-001: 性能约束
- **显存限制**: 严格控制在6GB以内
- **处理时间**: 接受长时间处理（数小时）
- **内存管理**: 瓦片大小128-192px，批处理大小1

### NFR-002: 兼容性要求
- **CLI接口**: 保持`python -m huaju4k enhance`不变
- **现有流程**: 7阶段编号保持不变
- **配置文件**: 向后兼容现有配置

### NFR-003: 可靠性要求
- **错误恢复**: 模型加载失败自动回退
- **资源清理**: 及时释放GPU内存
- **状态持久化**: 支持断点续传

### NFR-004: 可维护性要求
- **模块化设计**: 新增组件独立可测试
- **日志记录**: 详细的处理日志和性能指标
- **配置管理**: 策略JSON可序列化、可缓存、可复用

## 技术约束

### TC-001: 硬件环境
- **GPU**: NVIDIA GTX 1650 (4GB VRAM) 或同等级
- **系统**: WSL2 Ubuntu环境
- **内存**: 建议16GB以上系统内存

### TC-002: 软件依赖
- **Python**: 3.8+
- **OpenCV**: 4.13.0-pre (CUDA支持)
- **PyTorch**: 最新稳定版
- **Real-ESRGAN**: 最新版本
- **FFmpeg**: 4.4+

### TC-003: 算法约束
- **确定性算法**: 禁止基于主观理解的判断
- **数值驱动**: 所有决策基于统计数据和阈值
- **状态机模式**: 清晰的状态转换逻辑

## 验收标准

### AS-001: Stage 1验收
- [ ] 能稳定输出结构特征JSON
- [ ] 固定机位检测准确率>95%
- [ ] 灯光分析指标稳定
- [ ] 处理时间<30秒（2小时视频）

### AS-002: Stage 2验收
- [ ] 能稳定输出策略JSON
- [ ] 策略生成逻辑可追溯
- [ ] 显存约束策略有效
- [ ] 策略可序列化存储

### AS-003: Stage 3-4验收
- [ ] 严格按策略调度模型
- [ ] 显存占用不超过6GB
- [ ] 模型切换无内存泄漏
- [ ] 三阶段增强流程完整

### AS-004: 整体系统验收
- [ ] CLI接口保持兼容
- [ ] 7阶段流程完整执行
- [ ] 输出4K视频质量达到母版级标准
- [ ] 音视频同步准确
- [ ] 系统可长时间稳定运行

## 风险评估

### 高风险项
- **显存管理**: 6GB限制下的多模型调度
- **GAN控制**: 受控区域的准确分割
- **时序稳定**: 固定机位下的背景锁定

### 中风险项
- **音频处理**: 母版级音频增强的复杂度
- **性能优化**: 长视频处理的内存管理
- **兼容性**: 现有配置文件的升级

### 低风险项
- **结构分析**: 基于OpenCV的确定性算法
- **策略生成**: 基于规则的JSON输出
- **质量验证**: 数值化的验证指标

## 项目里程碑

### 里程碑1: Stage 1-2升级完成
- 舞台结构分析器实现
- 策略生成器实现
- 基础测试通过

### 里程碑2: Stage 3-4核心重构完成
- 模型调度器实现
- 三阶段视频增强实现
- 显存管理验证

### 里程碑3: Stage 5-7完整升级
- 母版级音频增强实现
- 质量验证升级
- 端到端测试通过

### 里程碑4: 系统集成与优化
- 性能优化完成
- 文档完善
- 生产环境部署就绪